function create_comparison(t){"undefined"==typeof details?$.ajax({url:"../details.json",success:function(e){make_comparison(t,e)}}):make_comparison(t,data)}function make_comparison(t,e){"undefined"==typeof ids&&(ids=["0","0"]),html='<table class="table small w-100 table-striped comparison-table"><thead>',v1_id=ids[0],v2_id=ids[1],html+="<tr><th>"+texts.question+'</th><th class="comp-center">'+answers[v1_id].short_name+'</th><th></th><th class="comp-center">'+answers[v2_id].short_name+"</th></tr>",html+="</thead><tbody>";for(key in t)q_id=t[key].id,vote1=answers[v1_id].vote[q_id],vote2=answers[v2_id].vote[q_id],detail1=get_detail(e,v1_id,q_id),detail2=get_detail(e,v2_id,q_id),void 0!==weights[q_id]?important="<i class='fa fa-star'></i> </span>":important="",html+="<tr><td>"+important+t[key].name+tooltip(t[key].question,"fa-info-circle"),html+="</td><td class='comp-center'>"+val2word(vote1),detail1&&(html+=tooltip(detail1,"fa-info-circle")),html+="</td><td class='comp-center'>",html+=compare_answers(vote1,vote2),html+="</td><td class='comp-center'>"+val2word(vote2),detail2&&(html+=tooltip(detail2,"fa-info-circle")),html+="</td></tr>";html+="</tbody></table>",$("#comparison-dialog").html(html),$(".tooltip-top").tooltip({placement:"top"})}function compare_answers(t,e){return t*e==-1?"<strong>âœ˜</strong>":""}function tooltip(t,e){return"<span data-toggle='tooltip' data-placement='top' title='"+t+"' class='tooltip-top'> <i class='fa "+e+"'></i> </span>"}function get_detail(t,e,i){return void 0!==t[e]&&(void 0!==t[e][i]&&t[e][i])}function val2word(t){return void 0===t?"=":1==t?texts.yes:-1==t?texts.no:"-"}function showmatrix(t,e,o){function a(t,e){out=[],i=0;for(key1 in e){j=0;for(key2 in e)id1=e[key1],id2=e[key2],item={id1:id1,id2:id2,i1:i,i2:j,val:t[id1][id2]},out.push(item),j++;i++}return out}contWidth=$("#viz").width();var r={top:0,right:0,bottom:0,left:0},n={top:100,right:0,bottom:0,left:100},s=contWidth-r.left-r.right-n.left-n.right,c=contWidth-r.top-r.bottom-n.top-n.bottom;square={padding:.2};var l=d3.scale.linear().range([0,Math.min(s,c)]),d=d3.scale.linear().range([0,Math.min(s,c)]),u=d3.scale.linear().domain([0,35,55,75,100]).range(["#880000","red","yellow","green","green"]);mpleft=r.left+n.left,mptop=r.top+n.top,$(function(){$("#viz").html("");var i=d3.select("#viz").append("svg").attr("width",s+r.left+r.right+n.left+n.right).attr("height",c+r.top+r.bottom+n.top+n.bottom).append("g").attr("transform","translate("+mpleft+","+mptop+")");ncat=Object.keys(t).length,square.size=Math.floor(Math.min(s,c)/ncat),square.innersize=Math.floor(square.size*(1-square.padding)),l.domain([0,ncat]),d.domain([0,ncat]),o.push("");var f=d3.scale.ordinal().domain(o).rangePoints([0,Math.floor(Math.min(s,c))]),m=d3.svg.axis().scale(f).orient("bottom"),p=d3.svg.axis().scale(f).orient("right"),h=i.append("g").attr("class","x axis").attr("transform","translate(0,-"+n.top/2+")").attr("font-size",function(){return Math.floor(.4*square.innersize)+"px"}).call(m);i.selectAll("g.axis text").attr("transform","rotate(-90)");var v=i.append("g").attr("class","y axis").attr("transform","translate(-"+n.left+","+square.size/2+")").attr("font-size",function(){return Math.floor(.4*square.innersize)+"px"}).call(p);data=a(t,e);var y=i.selectAll(".rect").data(data).enter().append("g").on("mouseover",function(t,e){icko=e,i.selectAll(".rect").filter(function(t,e){return e%ncat==icko%ncat||Math.floor(e/ncat)==Math.floor(icko/ncat)}).attr("class","rect hover"),v.selectAll("text").filter(function(t,e){return e%ncat==icko%ncat}).attr("class","hoverBold"),h.selectAll("text").filter(function(t,e){return e==Math.floor(icko/ncat)}).attr("class","hoverBold")}).on("mouseout",function(t,e){icko=e,i.selectAll(".rect").filter(function(t,e){return e%ncat==icko%ncat||Math.floor(e/ncat)==Math.floor(icko/ncat)}).attr("class","rect"),v.selectAll("text").filter(function(t,e){return e%ncat==icko%ncat}).attr("class",""),h.selectAll("text").filter(function(t,e){return e==Math.floor(icko/ncat)}).attr("class","")}).on("click",function(t,e){ids=[t.id2,t.id1],$("#modal").modal("show")});y.append("rect").attr("x",function(t){return l(t.i1)}).attr("y",function(t){return d(t.i2)}).attr("width",square.innersize).attr("height",square.innersize).style("fill",function(t){return u(t.val)}).attr("class","rect"),y.append("text").attr("text-anchor","middle").text(function(t,e){return t.val}).attr("x",function(t,e){return l(t.i1)+square.innersize/2}).attr("y",function(t,e){return d(t.i2)+square.innersize/2+(square.size-square.innersize)/2}).attr("class","descr").attr("font-size",function(){return Math.floor(.5*square.innersize)+"px"}).on("mouseover",function(t,e){}),category=d3.range(o.length-1);i.selectAll(".grayrect").data(category).enter().append("rect").attr("x",function(t){return l(t)}).attr("y",function(t){return d(t)}).attr("width",square.innersize).attr("height",square.innersize).attr("class","middle-rect")})}function data2category(t,e){out=[];for(key in e)item=e[key],out.push(t[item].short_name);return out}function addme(t){return out=t,out[0]=me,out}function positions(t,e,i){pos=[];for(key in t)pos.push([key,calc_position(t[key].vote,i,weights,e)]);pos.sort(function(t,e){return t[1]-e[1]}),out=[];for(key in pos)out.push(pos[key][0]);return out}function calc_position(t,e,i,o){s=0;for(k in e)id=e[k],void 0!==t[id]&&void 0!==o[id]&&(void 0!==i[id]?w=i[id]:w=1,s+=t[id]*w*o[id]);return s}function calculate(t){matrix={};for(key1 in t)for(key2 in t)void 0!==matrix[t[key1].id]&&void 0!==matrix[t[key1].id][t[key2].id]||(rn=Math.round(calc_match(t[key1].vote,t[key2].vote,voted,weights)),void 0===matrix[t[key1].id]&&(matrix[t[key1].id]={}),void 0===matrix[t[key2].id]&&(matrix[t[key2].id]={}),matrix[t[key1].id][t[key2].id]=rn,matrix[t[key2].id][t[key1].id]=rn);return matrix}function calc_match(t,e,o,a){s=0,c=0;for(i in o)id=o[i],void 0!==t[id]&&void 0!==e[id]&&(void 0!==a[id]?w=2:w=1,s+=t[id]*e[id]*w,c+=w);return rescale(0==c?0:s/c)}function rescale(t){return 50*(t+1)}$(document).on("click",".open-dialog",function(){ids=["0",$(this).data("id")]}),$("#modal").on("show.bs.modal",function(t){"undefined"==typeof questions?$.ajax({url:"../json/questions.json",success:function(t){create_comparison(t)}}):create_comparison(questions)});var voted=Object.keys(user.vote);data=addme(answers);var order=positions(data,qcoefs,voted),matrix=calculate(data),category1=data2category(data,order);$("a#tabs-comparison").on("shown.bs.tab",function(t){showmatrix(matrix,order,category1)});
